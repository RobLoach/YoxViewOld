/*!
 * YoxView Picasa plugin
 * http://yoxigen.com/yoxview/
 *
 * Copyright (c) 2010 Yossi Kolesnicov
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 11th March, 2010
 * Version : 1.01
 */ 
function yoxview_picasa(){function p(c){var e=c.url+c.user;if(c.album)e+="/album/"+c.album;e+="?imgmax="+c.imagesMaxSize+"&alt=json";if(c.thumbnailsMaxSize)e+="&thumbsize="+c.thumbnailsMaxSize;if(c.authkey)e+="&authkey="+c.authkey;return e}function o(c,e){for(var k=e.length;k>=0;k--){c=parseInt(c);var b=e[k];if(c>=b)return b}return c}function q(c,e,k){jQuery.each(c.feed.entry,function(b,a){b=a.summary.$t;a={thumbnailSrc:a.media$group.media$thumbnail[0].url,src:a.content.src,title:b,alt:b,link:a.link[1].href, thumbnailImg:e?e.children("img:first"):null};k.push(a)})}this.getImagesData=function(c,e,k,b){var a=jQuery.extend({},{url:"http://picasaweb.google.com/data/feed/api/user/",setThumbnail:true,setSingleAlbumThumbnails:true,setTitle:true},b.dataSourceOptions);if(a.album=="")a.album=null;if(a.imagesMaxSize)a.imagesMaxSize=o(a.imagesMaxSize,r);var m=screen.width>screen.height?screen.width:screen.height;if(!a.imagesMaxSize||m<a.imagesMaxSize)a.imagesMaxSize=o(m,r);if(a.thumbnailsMaxSize)a.thumbnailsMaxSize= o(a.thumbnailsMaxSize,v);m=p(a);var n=[],s=e.data("yoxview").viewIndex;if(a.album){b.onLoadBegin&&b.onLoadBegin();$.jsonp({url:m,async:false,dataType:"jsonp",callbackParameter:"callback",success:function(d){var f,i=d.feed,h=i.title.$t;if(!a.setSingleAlbumThumbnails&&a.setThumbnail){h=h+" ("+i.gphoto$numphotos.$t+" images)";f=createThumbnail(i.link[1].href,h,h,i.icon.$t,e.data("yoxview").viewIndex);f.bind("click.yoxview",function(){var g=$(this).data("yoxview");c.openGallery(g.viewIndex);return false}); f.appendTo(e);c.thumbnail=f}q(d,f,n);if(a.setSingleAlbumThumbnails&&n.length!=0){e.addClass("yoxview-thumbnails");if(a.setTitle){f=$("<div>",{className:"yoxview-thumbnails-details"});d=d.feed.author[0];f.append("<h2>"+h+"</h2>","By ","<a href='"+d.uri.$t+"' title=\"Go to "+d.name.$t+"'s Picasa page\" target='_blank'>"+d.name.$t+"</a>","<div style='clear:both;'></div>").prependTo(e)}$.each(n,function(g,j){var l=createThumbnail(j.src,j.alt,j.title,j.thumbnailSrc);j.thumbnailImg=l.children("img:first"); l.data("yoxview",{viewIndex:s,imageIndex:g}).bind("click.yoxview",function(){var t=$(this).data("yoxview");c.openGallery(t.viewIndex,t.imageIndex);return false}).appendTo(e)})}b.onLoadComplete&&b.onLoadComplete()},error:function(d,f){b.onLoadError&&b.onLoadError("Album '"+a.album+"' for user '"+a.user+"' not found.")}})}else{var u=0,w=/http:\/\/picasaweb.google.com\/([^\/]+)\/([^\?]+).*/;e.find("a:has(img)").each(function(){var d=$(this),f=this.href.match(w);if(f){f={user:f[1],album:f[2]};var i=d.data("yoxview"); i?jQuery.extend(i,f):d.data("yoxview",f);var h=d.parent().data("yoxview");d.bind("click.yoxview",function(){var g=$(this).data("yoxview");if(h.imagesAreSet)c.openGallery(d.parent().data("yoxview").viewIndex);else{d.css("cursor","wait");$.ajax({url:p(jQuery.extend(a,g)),dataType:"jsonp",success:function(j){var l=[];q(j,d,l);h.images=l;h.imagesAreSet=true;d.css("cursor","");c.openGallery(h.viewIndex)}})}return false});u++}});if(u==0){b.onLoadBegin&&b.onLoadBegin();$.jsonp({url:m,dataType:"jsonp",callbackParameter:"callback", success:function(d){if(d.feed.entry){if(a.setTitle){var f=d.feed.author[0];$("<div>",{className:"yoxview-thumbnails-details"}).append("<h2><a href='"+f.uri.$t+"' target='_blank' title=\"Go to "+f.name.$t+"'s gallery in Picasa\">"+f.name.$t+"</a>'s gallery</h2>","<div style='clear:both;'></div>").prependTo(e)}var i=$("<ul>",{className:"yoxview-thumbnails"});i.appendTo(e);jQuery.each(d.feed.entry,function(h,g){if(g.gphoto$numphotos.$t!="0"){h=g.title.$t+" ("+g.gphoto$numphotos.$t+" images)";var j=g.media$group.media$thumbnail[0].url, l=g.link[1].href;g=$("<li>",{css:{width:g.media$group.media$thumbnail[0].width,height:g.media$group.media$thumbnail[0].height}});createThumbnail(l,h,h,j,s).data("yoxview",{user:a.user,album:h}).appendTo(g);g.appendTo(i).yoxview(k,b)}});b.onLoadComplete&&b.onLoadComplete()}else b.onNoData&&b.onNoData()},error:function(d,f){b.onLoadError&&b.onLoadError("User '"+a.user+"' not found.")}})}}return n};var v=[32,48,64,72,104,144,150,160],r=[94,110,128,200,220,288,320,400,512,576,640,720,800,912,1024,1152, 1280,1440,1600]};