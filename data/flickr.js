/*!
 * YoxView Flickr plugin
 * http://yoxigen.com/yoxview/
 *
 * Copyright (c) 2010 Yossi Kolesnicov
 *
 * Licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license.php
 *
 * Date: 11th March, 2010
 * Version : 1.01
 */ 
function yoxview_flickr(){function s(e,f,h,d){var a=e.data("yoxview").viewIndex,j=[];$.jsonp({url:o,async:false,data:h,dataType:"jsonp",callbackParameter:"jsoncallback",success:function(g){if(g.photosets&&g.photosets.photoset.length!=0){var l=$("<ul>",{className:"yoxview-thumbnails"});l.appendTo(e);jQuery.each(g.photosets.photoset,function(b,c){b=c.title?c.title._content:"Set";b+=" ("+c.photos+" images)";var k=p(c,m[h.thumbnailsMaxSize]),i=q+"photos/"+(h.user||h.user_id)+"/sets/"+c.id,n=$("<li>", {css:{width:"75px",height:"75px"}});createThumbnail(i,b,b,k,a).data("yoxview",{user:h.user,user_id:h.user_id,photoset_id:c.id}).appendTo(n);n.appendTo(l);n.yoxview(f,d)})}else if(g.photoset&&g.photoset.photo.length!=0&&f.setSinglePhotosetThumbnails){t(g,undefined,j,h.imagesSize,h.thumbnailsMaxSize);e.addClass("yoxview-thumbnails");if(f.setTitle){var r=$("<div>",{className:"yoxview-thumbnails-details"});$.jsonp({url:o,async:false,data:$.extend({},{method:"flickr.photosets.getInfo",photoset_id:f.photoset_id}, u),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(b){b=b.photoset;r.append("<h2>"+b.title._content+"</h2>","By ","<a href='"+q+"photos/"+b.owner+"' title=\"Go to "+(f.user||"the user's")+"'s flickr page\" target='_blank'>"+f.user+"</a>","<div style='clear:both;'></div>").prependTo(e)}})}$.each(j,function(b,c){var k=createThumbnail(c.src,c.alt,c.title,c.thumbnailSrc);c.thumbnailImg=k.children("img:first");k.data("yoxview",{viewIndex:a,imageIndex:b}).bind("click.yoxview",function(){var i= $(this).data("yoxview");yoxviewObj.openGallery(i.viewIndex,i.imageIndex);return false}).appendTo(e)})}d.onLoadComplete&&d.onLoadComplete()},error:function(g,l){d.onLoadError&&d.onLoadError("Can't load data from flickr.")}});return j}function p(e,f){return"http://farm"+e.farm+".static.flickr.com/"+e.server+"/"+(e.primary||e.id)+"_"+e.secret+f+".jpg"}function t(e,f,h,d,a){jQuery.each(e.photoset.photo,function(j,g){j={thumbnailSrc:p(g,a?m[a]:m.smallSquare),src:p(g,d?m[d]:m.medium),title:g.title,alt:g.title, link:"",thumbnailImg:f?f.children("img:first"):null};h.push(j)})}var q="http://www.flickr.com/",o="http://api.flickr.com/services/rest/",w=/\d+@N\d+/,u={api_key:"cd6c91f9721f34ead20e6ebe03dd5871",format:"json"};this.getImagesData=function(e,f,h,d){var a=jQuery.extend({},{imagesSize:"medium",thumbnailsMaxSize:"smallSquare",setThumbnail:true,setSinglePhotosetThumbnails:true,setTitle:true,method:"flickr.photosets.getList"},d.dataSourceOptions,u);a.media="photos";if(a.user&&a.photoset_id)a.method="flickr.photosets.getPhotos"; var j=screen.width>screen.height?screen.width:screen.height;if(!a.imagesSize||j.width<=800&&a.imagesSize!="medium")a.imagesSize="medium";var g=[],l=0,r=/http:\/\/(www.)?flickr.com\/photos\/([^\/]+)\/sets\/([^\?]+).*/;f.find("a:has(img)").each(function(){var b=$(this),c=this.href.match(r);if(c){c={user:c[2],photoset_id:c[3]};var k=b.data("yoxview");k?jQuery.extend(k,c):b.data("yoxview",c);var i=b.parent().data("yoxview");b.bind("click.yoxview",function(){var n=$(this).data("yoxview");if(i.imagesAreSet)e.openGallery(b.parent().data("yoxview").viewIndex); else{b.css("cursor","wait");$.jsonp({url:o,data:jQuery.extend({},a,n,{method:"flickr.photosets.getPhotos",api_key:"cd6c91f9721f34ead20e6ebe03dd5871",format:"json",media:"photos"}),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(x){var v=[];t(x,b,v,a.imagesSize,a.thumbnailsMaxSize);i.images=v;i.imagesAreSet=true;b.css("cursor","");e.openGallery(i.viewIndex)}})}return false});l++}});if(l==0){d.onLoadBegin&&d.onLoadBegin();if(a.user&&a.user.match(w))a.user_id=a.user;if(!a.user_id&& a.user&&!a.photoset_id)$.jsonp({url:o,data:$.extend({},a,{username:a.user,method:"flickr.people.findByUsername"}),dataType:"jsonp",callbackParameter:"jsoncallback",success:function(b){if(!b.user&&d.onLoadError){d.onLoadError("User not found.");return false}a.user_id=b.user.nsid;if(a.setTitle){var c=$("<div>",{className:"yoxview-thumbnails-details"});b=b.user.username._content;c.append("<h2><a href='"+q+"photos/"+a.user_id+"' target='_blank' title=\"Go to "+b+"'s gallery in flickr\">"+b+"</a>'s sets:</h2>", "<div style='clear:both;'></div>").prependTo(f)}g=s(f,h,a,d)},error:function(b,c){d.onLoadError&&d.onLoadError("User not found. Have you tried using the NSID?")}});else g=s(f,a,a,d)}return g};var m={smallSquare:"_s",thumbnail:"_t",small:"_m",medium:"",large:"_b",original:"_o"}};